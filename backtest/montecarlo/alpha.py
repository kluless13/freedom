'''

# ALPHA DECAY which is a way to prevent lookahead bias in trading
# by simply adding a time delay to my curreny trading strategy

Running backtest with 0-minute delay...
Start                     2024-06-04 13:19:00
End                       2024-06-25 23:21:00
Duration                     21 days 10:02:00
Exposure Time [%]                   49.226729
Equity Final [$]                 517551.59198
Equity Peak [$]                 525463.080323
Return [%]                         417.551592
Buy & Hold Return [%]              -18.948474
Return (Ann.) [%]         54517753113952.1...
Volatility (Ann.) [%]        71397551514406.5
Sharpe Ratio                          0.76358
Sortino Ratio                             inf
Calmar Ratio              5609266978125.43...
Max. Drawdown [%]                    -9.71923
Avg. Drawdown [%]                   -0.808477
Max. Drawdown Duration        1 days 02:45:00
Avg. Drawdown Duration        0 days 01:53:00
# Trades                                  216
Win Rate [%]                        84.722222
Best Trade [%]                       3.234712
Worst Trade [%]                     -2.587665
Avg. Trade [%]                       0.764261
Max. Trade Duration           0 days 10:43:00
Avg. Trade Duration           0 days 01:10:00
Profit Factor                        6.545605
Expectancy [%]                       0.768172
SQN                                   9.37146
_strategy                 DelayedLiquidati...
_equity_curve                             ...
_trades                        Size  Entry...
dtype: object

==================================================

Running backtest with 1-minute delay...
Start                     2024-06-04 13:19:00
End                       2024-06-25 23:21:00
Duration                     21 days 10:02:00
Exposure Time [%]                   49.226729
Equity Final [$]                 517551.59198
Equity Peak [$]                 525463.080323
Return [%]                         417.551592
Buy & Hold Return [%]              -18.948474
Return (Ann.) [%]         54517753113952.1...
Volatility (Ann.) [%]        71397551514406.5
Sharpe Ratio                          0.76358
Sortino Ratio                             inf
Calmar Ratio              5609266978125.43...
Max. Drawdown [%]                    -9.71923
Avg. Drawdown [%]                   -0.808477
Max. Drawdown Duration        1 days 02:45:00
Avg. Drawdown Duration        0 days 01:53:00
# Trades                                  216
Win Rate [%]                        84.722222
Best Trade [%]                       3.234712
Worst Trade [%]                     -2.587665
Avg. Trade [%]                       0.764261
Max. Trade Duration           0 days 10:43:00
Avg. Trade Duration           0 days 01:10:00
Profit Factor                        6.545605
Expectancy [%]                       0.768172
SQN                                   9.37146
_strategy                 DelayedLiquidati...
_equity_curve                             ...
_trades                        Size  Entry...
dtype: object

==================================================

Running backtest with 2-minute delay...
Start                     2024-06-04 13:19:00
End                       2024-06-25 23:21:00
Duration                     21 days 10:02:00
Exposure Time [%]                   49.226729
Equity Final [$]                 517551.59198
Equity Peak [$]                 525463.080323
Return [%]                         417.551592
Buy & Hold Return [%]              -18.948474
Return (Ann.) [%]         54517753113952.1...
Volatility (Ann.) [%]        71397551514406.5
Sharpe Ratio                          0.76358
Sortino Ratio                             inf
Calmar Ratio              5609266978125.43...
Max. Drawdown [%]                    -9.71923
Avg. Drawdown [%]                   -0.808477
Max. Drawdown Duration        1 days 02:45:00
Avg. Drawdown Duration        0 days 01:53:00
# Trades                                  216
Win Rate [%]                        84.722222
Best Trade [%]                       3.234712
Worst Trade [%]                     -2.587665
Avg. Trade [%]                       0.764261
Max. Trade Duration           0 days 10:43:00
Avg. Trade Duration           0 days 01:10:00
Profit Factor                        6.545605
Expectancy [%]                       0.768172
SQN                                   9.37146
_strategy                 DelayedLiquidati...
_equity_curve                             ...
_trades                        Size  Entry...
dtype: object

==================================================

Running backtest with 5-minute delay...
Start                     2024-06-04 13:19:00
End                       2024-06-25 23:21:00
Duration                     21 days 10:02:00
Exposure Time [%]                   49.291573
Equity Final [$]                526374.533943
Equity Peak [$]                 534425.592185
Return [%]                         426.374534
Buy & Hold Return [%]              -18.948474
Return (Ann.) [%]         72166472979592.0625
Volatility (Ann.) [%]     101525840801157....
Sharpe Ratio                         0.710819
Sortino Ratio                             inf
Calmar Ratio              7425359650107.88...
Max. Drawdown [%]                    -9.71892
Avg. Drawdown [%]                   -0.812534
Max. Drawdown Duration        1 days 02:45:00
Avg. Drawdown Duration        0 days 01:54:00
# Trades                                  216
Win Rate [%]                        84.722222
Best Trade [%]                       6.232469
Worst Trade [%]                     -2.587665
Avg. Trade [%]                       0.772153
Max. Trade Duration           0 days 10:43:00
Avg. Trade Duration           0 days 01:10:00
Profit Factor                        6.505816
Expectancy [%]                       0.776645
SQN                                  9.076199
_strategy                 DelayedLiquidati...
_equity_curve                             ...
_trades                        Size  Entry...
dtype: object

==================================================

Running backtest with 10-minute delay...
Start                     2024-06-04 13:19:00
End                       2024-06-25 23:21:00
Duration                     21 days 10:02:00
Exposure Time [%]                   49.499076
Equity Final [$]                502117.284827
Equity Peak [$]                 509797.436779
Return [%]                         402.117285
Buy & Hold Return [%]              -18.948474
Return (Ann.) [%]         32990793455811.4...
Volatility (Ann.) [%]     38271862863123.1...
Sharpe Ratio                         0.862012
Sortino Ratio                             inf
Calmar Ratio              3394428912771.08...
Max. Drawdown [%]                     -9.7191
Avg. Drawdown [%]                   -0.827992
Max. Drawdown Duration        1 days 02:45:00
Avg. Drawdown Duration        0 days 01:55:00
# Trades                                  215
Win Rate [%]                        84.651163
Best Trade [%]                       2.074337
Worst Trade [%]                     -2.587665
Avg. Trade [%]                       0.753627
Max. Trade Duration           0 days 10:43:00
Avg. Trade Duration           0 days 01:11:00
Profit Factor                        6.258804
Expectancy [%]                       0.757517
SQN                                  9.274843
_strategy                 DelayedLiquidati...
_equity_curve                             ...
_trades                        Size  Entry...
dtype: object

==================================================

Running backtest with 15-minute delay...
Start                     2024-06-04 13:19:00
End                       2024-06-25 23:21:00
Duration                     21 days 10:02:00
Exposure Time [%]                   49.978926
Equity Final [$]                 489570.30929
Equity Peak [$]                 497055.262182
Return [%]                         389.570309
Buy & Hold Return [%]              -18.948474
Return (Ann.) [%]         21679886642840.1...
Volatility (Ann.) [%]     26561868876912.5625
Sharpe Ratio                         0.816203
Sortino Ratio                             inf
Calmar Ratio              2230726258843.54...
Max. Drawdown [%]                   -9.718757
Avg. Drawdown [%]                   -0.899243
Max. Drawdown Duration        1 days 02:45:00
Avg. Drawdown Duration        0 days 02:02:00
# Trades                                  215
Win Rate [%]                        81.860465
Best Trade [%]                       3.468975
Worst Trade [%]                     -2.587665
Avg. Trade [%]                       0.741771
Max. Trade Duration           0 days 10:43:00
Avg. Trade Duration           0 days 01:11:00
Profit Factor                         5.35856
Expectancy [%]                       0.746579
SQN                                  8.447445
_strategy                 DelayedLiquidati...
_equity_curve                             ...
_trades                        Size  Entry...
dtype: object

==================================================

Running backtest with 30-minute delay...
Start                     2024-06-04 13:19:00
End                       2024-06-25 23:21:00
Duration                     21 days 10:02:00
Exposure Time [%]                   51.544921
Equity Final [$]                383811.089726
Equity Peak [$]                 389676.870585
Return [%]                          283.81109
Buy & Hold Return [%]              -18.948474
Return (Ann.) [%]         342554711224.506775
Volatility (Ann.) [%]     355609134267.076233
Sharpe Ratio                          0.96329
Sortino Ratio              261411902364.11438
Calmar Ratio               35250535252.607643
Max. Drawdown [%]                   -9.717717
Avg. Drawdown [%]                   -1.127627
Max. Drawdown Duration        1 days 02:45:00
Avg. Drawdown Duration        0 days 02:38:00
# Trades                                  199
Win Rate [%]                        78.894472
Best Trade [%]                       3.269287
Worst Trade [%]                     -2.792557
Avg. Trade [%]                       0.678443
Max. Trade Duration           0 days 10:43:00
Avg. Trade Duration           0 days 01:19:00
Profit Factor                        4.033132
Expectancy [%]                       0.684409
SQN                                  7.393979
_strategy                 DelayedLiquidati...
_equity_curve                             ...
_trades                        Size  Entry...
dtype: object

==================================================

Running backtest with 60-minute delay...
Start                     2024-06-04 13:19:00
End                       2024-06-25 23:21:00
Duration                     21 days 10:02:00
Exposure Time [%]                    56.24615
Equity Final [$]                352069.588942
Equity Peak [$]                 364141.426727
Return [%]                         252.069589
Buy & Hold Return [%]              -18.948474
Return (Ann.) [%]          87287614141.322052
Volatility (Ann.) [%]      70050143584.430328
Sharpe Ratio                         1.246073
Sortino Ratio                             inf
Calmar Ratio                7502576652.974547
Max. Drawdown [%]                  -11.634352
Avg. Drawdown [%]                   -1.174989
Max. Drawdown Duration        1 days 03:56:00
Avg. Drawdown Duration        0 days 02:46:00
# Trades                                  179
Win Rate [%]                        73.184358
Best Trade [%]                       5.639541
Worst Trade [%]                     -2.424906
Avg. Trade [%]                        0.70591
Max. Trade Duration           0 days 10:43:00
Avg. Trade Duration           0 days 01:36:00
Profit Factor                        4.180728
Expectancy [%]                       0.712905
SQN                                  6.888791
_strategy                 DelayedLiquidati...
_equity_curve                             ...
_trades                        Size  Entry...
dtype: object

==================================================



'''

import numpy as np
from backtesting import Backtest, Strategy
import pandas as pd
import warnings
warnings.filterwarnings('ignore')

class LiquidationStrategy(Strategy):
    long_liquidation_thresh = 1000  # Default long liquidation threshold for buying
    short_liquidation_thresh = 1000  # Default short liquidation threshold for shorting
    time_window_mins = 2  # Default time window in minutes
    long_liquidation_closure_thresh = 1000  # Default long liquidation threshold for closing shorts
    short_liquidation_closure_thresh = 1000  # Default short liquidation threshold for closing longs

    def init(self):
        self.liquidations = self.data.liquidations
        self.short_liquidations = self.data.short_liquidations
        self.long_liquidations = self.data.long_liquidations
        self.trade_start_idx = None  # To track the start index of the current trade

    def next(self):
        current_idx = len(self.data.Close) - 1
        current_time = self.data.index[current_idx]  # Current time

        # Define the start time of the window
        start_time = current_time - pd.Timedelta(minutes=self.time_window_mins)

        # Find indices for slicing
        start_idx = np.searchsorted(self.data.index, start_time, side='left')

        # Sum long and short liquidations within the time window for entry
        recent_long_liquidations = self.long_liquidations[start_idx:current_idx + 1].sum()
        recent_short_liquidations = self.short_liquidations[start_idx:current_idx + 1].sum()

        # Buy if long liquidations exceed the threshold and we are not in a current position
        if recent_long_liquidations >= self.long_liquidation_thresh and not self.position:
            #self.buy()
            #self.trade_start_idx = current_idx  # Note the index where the trade started
            pass

        # Short if short liquidations exceed the threshold and we are not in a current position
        elif recent_short_liquidations >= self.short_liquidation_thresh and not self.position:
            self.sell()
            self.trade_start_idx = current_idx  # Note the index where the trade started

        # Check if a long position is open and we should close it based on short liquidations
        if self.position.is_long:
            # Sum short liquidations since the trade was opened for exit
            trade_short_liquidations = self.short_liquidations[self.trade_start_idx:current_idx + 1].sum()
            if trade_short_liquidations >= self.short_liquidation_closure_thresh:
                self.position.close()

        # Check if a short position is open and we should close it based on long liquidations
        if self.position.is_short:
            # Sum long liquidations since the trade was opened for exit
            trade_long_liquidations = self.long_liquidations[self.trade_start_idx:current_idx + 1].sum()
            if trade_long_liquidations >= self.long_liquidation_closure_thresh:
                self.position.close()

class DelayedLiquidationStrategy(LiquidationStrategy):
    delay_minutes = 0  # No delay by default

    def next(self):
        # If there is a trade start index, check the delay
        if self.trade_start_idx is not None:
            # Calculate how many bars have passed since the trade signal
            bars_since_trade_start = len(self.data.Close) - self.trade_start_idx
            if bars_since_trade_start < self.delay_minutes:
                return  # Skip execution if the delay period has not passed

        # Execute the base strategy logic
        super().next()
# Load the data
data_path = '/Users/md/Dropbox/dev/github/hyper-liquid-trading-bots/backtests/liquidations/data/SOL_liq_data_062622_to_062624.csv'  # Replace with the correct path
data = pd.read_csv(data_path)

# Convert 'datetime' column to datetime format and set as index
data['datetime'] = pd.to_datetime(data['datetime'])
data.set_index('datetime', inplace=True)

# Ensure necessary columns are present
data = data[['symbol', 'side', 'LIQ_SIDE', 'price', 'usd_size']]

# Create required columns for the backtest to run
data['Open'] = data['price']
data['High'] = data['price']
data['Low'] = data['price']
data['Close'] = data['price']

# Aggregate data by minute to handle duplicates
data = data.resample('T').agg({
    'symbol': 'first',
    'side': 'first',
    'LIQ_SIDE': 'first',
    'price': 'mean',
    'usd_size': 'sum',
    'Open': 'mean',
    'High': 'mean',
    'Low': 'mean',
    'Close': 'mean'
})

# Forward fill price-related columns
price_columns = ['price', 'Open', 'High', 'Low', 'Close']
data[price_columns] = data[price_columns].ffill()

# Set usd_size to 0 for missing data
data['usd_size'].fillna(0, inplace=True)

# Add new columns 'liquidations', 'short_liquidations', and 'long_liquidations'
data['liquidations'] = data['usd_size']
data['short_liquidations'] = data.apply(lambda row: row['usd_size'] if row['side'] == 'BUY' else 0, axis=1)
data['long_liquidations'] = data.apply(lambda row: row['usd_size'] if row['side'] == 'SELL' else 0, axis=1)

# Ensure the DataFrame is sorted by the index
data.sort_index(inplace=True)

def run_alpha_decay_test(data, strategy_class, delays):
    for delay in delays:
        print(f"Running backtest with {delay}-minute delay...")
        # Set the delay in the strategy class
        strategy_class.delay_minutes = delay

        # Create and configure the backtest
        bt = Backtest(data, strategy_class, cash=100000, commission=0.002)

        # Run the backtest and print the results
        stats = bt.run()
        print(stats)
        print("\n" + "="*50 + "\n")

# Define delay intervals in minutes
delays = [0, 1, 2, 5, 10, 15, 30, 60]

# Run the alpha decay test
run_alpha_decay_test(data, DelayedLiquidationStrategy, delays)

